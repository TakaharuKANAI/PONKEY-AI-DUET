<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponkey AI Duet - Working Magenta.js</title>
    
    <!-- Load dependencies in correct order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.58/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/1.2.8/tf.min.js"></script>
    
    <!-- Load Magenta.js core and music_rnn bundle -->
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0/es6/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0/es6/music_rnn.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 42px;
            font-weight: 300;
            letter-spacing: 6px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .model-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-title {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #4ecdc4;
            box-shadow: 0 0 10px #4ecdc4;
        }

        .status-indicator.loading {
            background: #ffd93d;
            box-shadow: 0 0 10px #ffd93d;
            animation: pulse 1s infinite;
        }

        .status-indicator.disconnected {
            background: #ff6b6b;
            box-shadow: 0 0 10px #ff6b6b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 40px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #c44569);
        }

        .ai-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .ai-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ai-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 14px;
        }

        .setting-input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: white;
        }

        .visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .viz-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
        }

        .viz-title {
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .piano-roll {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            height: 120px;
        }

        .note-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .note-bar.active {
            background: linear-gradient(to top, #4ecdc4, #44a08d);
            animation: noteGlow 0.5s ease-out;
        }

        .note-bar.ai-response {
            background: linear-gradient(to top, #ff6b6b, #ee5a24);
            animation: aiGlow 0.5s ease-out;
        }

        @keyframes noteGlow {
            0% { box-shadow: 0 0 0 rgba(78, 205, 196, 0); }
            50% { box-shadow: 0 0 20px rgba(78, 205, 196, 0.8); }
            100% { box-shadow: 0 0 0 rgba(78, 205, 196, 0); }
        }

        @keyframes aiGlow {
            0% { box-shadow: 0 0 0 rgba(255, 107, 107, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
            100% { box-shadow: 0 0 0 rgba(255, 107, 107, 0); }
        }

        .log-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .log-entry.ai {
            color: #ff6b6b;
        }

        .log-entry.midi {
            color: #4ecdc4;
        }

        .log-entry.ponkey {
            color: #ffd93d;
        }

        .log-entry.keyboard {
            color: #a29bfe;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .device-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .device-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .device-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .loading-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1, #667eea);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-status {
            font-size: 14px;
            opacity: 0.8;
        }

        .model-reload-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 10px;
            text-align: center;
        }

        .model-reload-section p {
            margin-bottom: 10px;
            color: #ffd93d;
        }

        /* Virtual Keyboard Styles */
        .keyboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .keyboard-section h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .virtual-keyboard {
            display: flex;
            justify-content: center;
            position: relative;
            height: 180px;
            margin: 20px 0;
        }

        .keyboard-container {
            position: relative;
            display: flex;
        }

        .white-key {
            width: 50px;
            height: 160px;
            background: linear-gradient(to bottom, #fff, #e8e8e8);
            border: 1px solid #999;
            border-radius: 0 0 6px 6px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 10px;
            cursor: pointer;
            transition: all 0.1s;
            margin: 0 2px;
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #f0f0f0, #ddd);
        }

        .white-key.pressed {
            background: linear-gradient(to bottom, #4ecdc4, #44a08d);
            transform: translateY(2px);
        }

        .white-key .note-name {
            color: #333;
            font-size: 14px;
            font-weight: bold;
        }

        .white-key .key-label {
            color: #666;
            font-size: 18px;
            margin-top: 5px;
            text-transform: uppercase;
        }

        .black-key {
            position: absolute;
            top: 0;
            width: 32px;
            height: 100px;
            background: linear-gradient(to bottom, #333, #000);
            border: 1px solid #000;
            border-radius: 0 0 4px 4px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 8px;
            cursor: pointer;
            transition: all 0.1s;
            z-index: 10;
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #444, #111);
        }

        .black-key.pressed {
            background: linear-gradient(to bottom, #ff6b6b, #ee5a24);
            transform: translateY(2px);
        }

        .black-key .note-name {
            color: #fff;
            font-size: 10px;
        }

        .black-key .key-label {
            color: #ccc;
            font-size: 14px;
            margin-top: 3px;
            text-transform: uppercase;
        }

        /* Black key positions - between white keys */
        .black-key[data-note="1"] { left: 36px; }   /* C# between C and D */
        .black-key[data-note="3"] { left: 90px; }   /* D# between D and E */
        .black-key[data-note="6"] { left: 198px; }  /* F# between F and G */
        .black-key[data-note="8"] { left: 252px; }  /* G# between G and A */
        .black-key[data-note="10"] { left: 306px; } /* A# between A and B */

        .keyboard-hint {
            text-align: center;
            opacity: 0.7;
            font-size: 14px;
            margin-top: 10px;
        }

        .octave-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .octave-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .octave-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .octave-display {
            font-size: 18px;
            min-width: 100px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .visualization {
                grid-template-columns: 1fr;
            }
            
            .status-panel {
                grid-template-columns: 1fr;
            }

            .white-key {
                width: 38px;
                height: 130px;
            }

            .black-key {
                width: 26px;
                height: 80px;
            }

            /* Adjusted positions for mobile */
            .black-key[data-note="1"] { left: 28px; }
            .black-key[data-note="3"] { left: 70px; }
            .black-key[data-note="6"] { left: 154px; }
            .black-key[data-note="8"] { left: 196px; }
            .black-key[data-note="10"] { left: 238px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">PONKEY AI DUET</h1>

            <div class="model-status" id="modelStatus">
                <span class="status-indicator loading" id="modelIndicator"></span>
                <span id="modelStatusText">Loading dependencies...</span>
            </div>
        </div>

        <div class="keyboard-section">
            <div class="virtual-keyboard">
                <div class="keyboard-container">
                    <!-- White Keys -->
                    <div class="white-key" data-note="0">
                        <span class="note-name">C</span>
                        <span class="key-label">A</span>
                    </div>
                    <div class="white-key" data-note="2">
                        <span class="note-name">D</span>
                        <span class="key-label">S</span>
                    </div>
                    <div class="white-key" data-note="4">
                        <span class="note-name">E</span>
                        <span class="key-label">D</span>
                    </div>
                    <div class="white-key" data-note="5">
                        <span class="note-name">F</span>
                        <span class="key-label">F</span>
                    </div>
                    <div class="white-key" data-note="7">
                        <span class="note-name">G</span>
                        <span class="key-label">G</span>
                    </div>
                    <div class="white-key" data-note="9">
                        <span class="note-name">A</span>
                        <span class="key-label">H</span>
                    </div>
                    <div class="white-key" data-note="11">
                        <span class="note-name">B</span>
                        <span class="key-label">J</span>
                    </div>
                    <div class="white-key" data-note="12">
                        <span class="note-name">C</span>
                        <span class="key-label">K</span>
                    </div>
                    <!-- Black Keys (positioned absolutely) -->
                    <div class="black-key" data-note="1">
                        <span class="note-name">C#</span>
                        <span class="key-label">W</span>
                    </div>
                    <div class="black-key" data-note="3">
                        <span class="note-name">D#</span>
                        <span class="key-label">E</span>
                    </div>
                    <div class="black-key" data-note="6">
                        <span class="note-name">F#</span>
                        <span class="key-label">T</span>
                    </div>
                    <div class="black-key" data-note="8">
                        <span class="note-name">G#</span>
                        <span class="key-label">Y</span>
                    </div>
                    <div class="black-key" data-note="10">
                        <span class="note-name">A#</span>
                        <span class="key-label">U</span>
                    </div>
                </div>
            </div>
            <div class="octave-control">
                <button class="octave-btn" id="octaveDown">‚óÄ -1</button>
                <span class="octave-display">Octave: <span id="currentOctave">4</span></span>
                <button class="octave-btn" id="octaveUp">+1 ‚ñ∂</button>
            </div>
            <p class="keyboard-hint">Use Z/X to change octave, or click the buttons above</p>
        </div>

        <div class="loading-section" id="loadingSection">
            <h3 style="margin-bottom: 15px;">üöÄ Initializing...</h3>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-status" id="progressStatus">Checking libraries...</div>
        </div>


        <div class="status-panel">
            <div class="status-card">
                <div class="status-title">MIDI / Keyboard Input</div>
                <div class="status-value">
                    <span class="status-indicator connected" id="midiIndicator"></span>
                    <span id="midiStatus">Keyboard Ready</span>
                </div>
                <div id="midiDeviceName">Computer Keyboard Active</div>
            </div>

            <div class="status-card">
                <div class="status-title">Ponkey Device</div>
                <div class="status-value">
                    <span class="status-indicator disconnected" id="ponkeyIndicator"></span>
                    <span id="ponkeyStatus">Disconnected</span>
                </div>
                <div id="ponkeyDeviceName">No device connected</div>
            </div>

            <div class="status-card">
                <div class="status-title">Activity</div>
                <div class="status-value" id="activityCounter">0</div>
                <div>Notes played</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn primary" id="connectMidiBtn">Connect MIDI</button>
            <button class="btn secondary" id="connectPonkeyBtn">Connect Ponkey</button>
            <button class="btn" id="startDuetBtn" disabled>Start AI Duet</button>
            <button class="btn" id="stopDuetBtn" disabled>Stop Duet</button>
            <button class="btn danger" id="resetBtn">Reset</button>
        </div>

        <div class="ai-panel">
            <h3 class="ai-title">üé∑ AI Configuration</h3>
            <div class="ai-settings">
                <div class="setting-group">
                    <label class="setting-label">AI Model</label>
                    <select class="select" id="aiModel">
                        <option value="melody_rnn">MelodyRNN (Basic)</option>
                        <option value="attention_rnn">AttentionRNN (Long context)</option>
                        <option value="improv_rnn" selected>ImprovRNN (Jazz/Chord-aware)</option>
                    </select>
                </div>
                <div class="setting-group" id="chordProgressionGroup">
                    <label class="setting-label">Chord Progression</label>
                    <select class="select" id="chordProgression">
                        <option value="ii-V-I">ii-V-I (Jazz Standard)</option>
                        <option value="I-vi-ii-V">I-vi-ii-V (Turnaround)</option>
                        <option value="blues">12-Bar Blues</option>
                        <option value="rhythm">Rhythm Changes</option>
                        <option value="modal">Modal (Dorian)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Temperature (Creativity)</label>
                    <input type="range" class="setting-input" id="temperature" min="0.3" max="1.5" step="0.1" value="1.1">
                    <span id="temperatureValue">1.1 üé≤</span>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Response Delay (ms)</label>
                    <input type="range" class="setting-input" id="responseDelay" min="300" max="2000" value="800">
                    <span id="responseDelayValue">800ms</span>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Response Length</label>
                    <input type="range" class="setting-input" id="responseSteps" min="8" max="64" value="24">
                    <span id="responseStepsValue">24 steps</span>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Swing Amount</label>
                    <input type="range" class="setting-input" id="swingAmount" min="0" max="100" value="60">
                    <span id="swingAmountValue">60% üé∫</span>
                </div>
            </div>
            <div class="model-reload-section" id="modelReloadSection" style="display: none;">
                <p>‚ö†Ô∏è Model change requires reload</p>
                <button class="btn primary" id="reloadModelBtn">Reload Model</button>
            </div>
        </div>

        <div class="visualization">
            <div class="viz-panel">
                <h4 class="viz-title">Piano Roll (Your Input = Blue, AI Response = Red)</h4>
                <div class="piano-roll" id="pianoRoll"></div>
            </div>
            <div class="viz-panel">
                <h4 class="viz-title">Activity Log</h4>
                <div class="log-panel" id="logPanel"></div>
            </div>
        </div>
    </div>

    <!-- MIDI Selection Modal -->
    <div class="modal" id="midiModal">
        <div class="modal-content">
            <h3 class="modal-title">Select MIDI Device</h3>
            <div class="device-list" id="midiDeviceList"></div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn" id="cancelMidiBtn">Cancel</button>
                <button class="btn primary" id="refreshMidiBtn">Refresh</button>
            </div>
        </div>
    </div>

    <!-- Ponkey Connection Modal -->
    <div class="modal" id="ponkeyModal">
        <div class="modal-content">
            <h3 class="modal-title">Connect to Ponkey</h3>
            <p style="margin: 20px 0; opacity: 0.8;">Searching for Ponkey devices...</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" id="cancelPonkeyBtn">Cancel</button>
                <button class="btn primary" id="connectPonkeyDeviceBtn">Connect</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables that will be available after libraries load
        let magentaModel = null;
        let isModelLoaded = false;
        let player = null;
        let currentModelType = 'improv_rnn';

        // Model URLs
        const MODEL_URLS = {
            'melody_rnn': 'https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/melody_rnn',
            'attention_rnn': 'https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/attention_rnn',
            'improv_rnn': 'https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv'
        };

        // Chord progressions (MIDI pitch classes for each chord)
        const CHORD_PROGRESSIONS = {
            'ii-V-I': [
                { chord: 'Dm7', steps: 8 },
                { chord: 'G7', steps: 8 },
                { chord: 'Cmaj7', steps: 16 }
            ],
            'I-vi-ii-V': [
                { chord: 'Cmaj7', steps: 8 },
                { chord: 'Am7', steps: 8 },
                { chord: 'Dm7', steps: 8 },
                { chord: 'G7', steps: 8 }
            ],
            'blues': [
                { chord: 'C7', steps: 8 },
                { chord: 'C7', steps: 8 },
                { chord: 'C7', steps: 8 },
                { chord: 'C7', steps: 8 },
                { chord: 'F7', steps: 8 },
                { chord: 'F7', steps: 8 },
                { chord: 'C7', steps: 8 },
                { chord: 'C7', steps: 8 },
                { chord: 'G7', steps: 8 },
                { chord: 'F7', steps: 8 },
                { chord: 'C7', steps: 8 },
                { chord: 'G7', steps: 8 }
            ],
            'rhythm': [
                { chord: 'Cmaj7', steps: 4 },
                { chord: 'A7', steps: 4 },
                { chord: 'Dm7', steps: 4 },
                { chord: 'G7', steps: 4 },
                { chord: 'Em7', steps: 4 },
                { chord: 'A7', steps: 4 },
                { chord: 'Dm7', steps: 4 },
                { chord: 'G7', steps: 4 }
            ],
            'modal': [
                { chord: 'Dm7', steps: 16 },
                { chord: 'Dm7', steps: 16 }
            ]
        };

        // Keyboard to MIDI note mapping
        // Layout:
        //   W  E     T  Y  U
        //  C# D#   F# G# A#
        // A  S  D  F  G  H  J  K
        // C  D  E  F  G  A  B  C
        const keyboardMap = {
            // White keys (lower row)
            'a': 0,   // C
            's': 2,   // D
            'd': 4,   // E
            'f': 5,   // F
            'g': 7,   // G
            'h': 9,   // A
            'j': 11,  // B
            'k': 12,  // C (next octave)
            // Black keys (upper row)
            'w': 1,   // C#
            'e': 3,   // D#
            't': 6,   // F#
            'y': 8,   // G#
            'u': 10,  // A#
        };

        // Track which keys are currently pressed
        const pressedKeys = new Set();

        // Application state
        const app = {
            midiInput: null,
            ponkeyDevice: null,
            ponkeyCharacteristic: null,
            aiActive: false,
            noteCount: 0,
            recentNotes: [],
            inputSequence: [],
            audioContext: null,
            isRecording: false,
            recordingStartTime: 0,
            currentPitchBend: 0,
            activeOscillators: new Map(),
            currentOctave: 4,  // Default octave (C4 = MIDI 60)
            keyboardEnabled: true  // Enable keyboard input by default
        };

        // Constants
        const PONKEY_SERVICE_UUID = '03b80e5a-ede8-4b33-a751-6ce34ec4c700';
        const PONKEY_CHAR_UUID = '7772e5db-3868-4112-a1a9-f2669d106bf3';

        // Logging function
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateModelStatus(status, text) {
            const indicator = document.getElementById('modelIndicator');
            const statusText = document.getElementById('modelStatusText');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
        }

        // Keyboard Input Handling
        function initKeyboardInput() {
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            log('Computer keyboard input initialized', 'keyboard');
        }

        function handleKeyDown(event) {
            // Ignore if typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }

            const key = event.key.toLowerCase();

            // Octave change with Z and X
            if (key === 'z') {
                changeOctave(-1);
                return;
            }
            if (key === 'x') {
                changeOctave(1);
                return;
            }

            // Check if this key is mapped to a note
            if (keyboardMap.hasOwnProperty(key)) {
                event.preventDefault();
                
                // Prevent key repeat
                if (pressedKeys.has(key)) {
                    return;
                }
                
                pressedKeys.add(key);
                
                const noteOffset = keyboardMap[key];
                const midiNote = (app.currentOctave * 12) + noteOffset;
                const velocity = 100; // Fixed velocity for keyboard
                
                handleNoteOn(midiNote, velocity);
                updateVirtualKeyboard(key, true);
                
                log(`Keyboard: ${key.toUpperCase()} ‚Üí Note ${midiNote}`, 'keyboard');
            }
        }

        function handleKeyUp(event) {
            const key = event.key.toLowerCase();

            if (keyboardMap.hasOwnProperty(key)) {
                event.preventDefault();
                pressedKeys.delete(key);
                
                const noteOffset = keyboardMap[key];
                const midiNote = (app.currentOctave * 12) + noteOffset;
                
                handleNoteOff(midiNote);
                updateVirtualKeyboard(key, false);
            }
        }

        function changeOctave(delta) {
            const newOctave = app.currentOctave + delta;
            if (newOctave >= 0 && newOctave <= 8) {
                app.currentOctave = newOctave;
                document.getElementById('currentOctave').textContent = newOctave;
                log(`Octave changed to ${newOctave}`, 'keyboard');
            }
        }

        function updateVirtualKeyboard(key, isPressed) {
            const noteOffset = keyboardMap[key];
            const keyElement = document.querySelector(`[data-note="${noteOffset}"]`);
            
            if (keyElement) {
                if (isPressed) {
                    keyElement.classList.add('pressed');
                } else {
                    keyElement.classList.remove('pressed');
                }
            }
        }

        function initVirtualKeyboardClicks() {
            // White keys
            document.querySelectorAll('.white-key').forEach(key => {
                key.addEventListener('mousedown', (e) => {
                    const noteOffset = parseInt(key.dataset.note);
                    const midiNote = (app.currentOctave * 12) + noteOffset;
                    handleNoteOn(midiNote, 100);
                    key.classList.add('pressed');
                });
                
                key.addEventListener('mouseup', (e) => {
                    const noteOffset = parseInt(key.dataset.note);
                    const midiNote = (app.currentOctave * 12) + noteOffset;
                    handleNoteOff(midiNote);
                    key.classList.remove('pressed');
                });
                
                key.addEventListener('mouseleave', (e) => {
                    if (key.classList.contains('pressed')) {
                        const noteOffset = parseInt(key.dataset.note);
                        const midiNote = (app.currentOctave * 12) + noteOffset;
                        handleNoteOff(midiNote);
                        key.classList.remove('pressed');
                    }
                });
            });

            // Black keys
            document.querySelectorAll('.black-key').forEach(key => {
                key.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    const noteOffset = parseInt(key.dataset.note);
                    const midiNote = (app.currentOctave * 12) + noteOffset;
                    handleNoteOn(midiNote, 100);
                    key.classList.add('pressed');
                });
                
                key.addEventListener('mouseup', (e) => {
                    const noteOffset = parseInt(key.dataset.note);
                    const midiNote = (app.currentOctave * 12) + noteOffset;
                    handleNoteOff(midiNote);
                    key.classList.remove('pressed');
                });
                
                key.addEventListener('mouseleave', (e) => {
                    if (key.classList.contains('pressed')) {
                        const noteOffset = parseInt(key.dataset.note);
                        const midiNote = (app.currentOctave * 12) + noteOffset;
                        handleNoteOff(midiNote);
                        key.classList.remove('pressed');
                    }
                });
            });

            // Octave buttons
            document.getElementById('octaveDown').addEventListener('click', () => changeOctave(-1));
            document.getElementById('octaveUp').addEventListener('click', () => changeOctave(1));
        }

        // Test functions for debugging
        function testLibraries() {
            log('Testing library availability...', 'ai');
            
            if (typeof Tone !== 'undefined') {
                log('‚úì Tone.js loaded successfully', 'ai');
            } else {
                log('‚úó Tone.js not loaded', 'ai');
                return false;
            }
            
            if (typeof tf !== 'undefined') {
                log('‚úì TensorFlow.js loaded successfully', 'ai');
            } else {
                log('‚úó TensorFlow.js not loaded', 'ai');
                return false;
            }
            
            if (typeof core !== 'undefined') {
                log('‚úì Magenta.js core loaded successfully', 'ai');
                player = new core.Player();
                log('‚úì Magenta player created', 'ai');
            } else {
                log('‚úó Magenta.js core not loaded', 'ai');
                return false;
            }
            
            if (typeof music_rnn !== 'undefined') {
                log('‚úì Magenta.js music_rnn loaded successfully', 'ai');
                return true;
            } else {
                log('‚úó Magenta.js music_rnn not loaded', 'ai');
                return false;
            }
        }

        async function testModel() {
            try {
                log('Creating MusicRNN model...', 'ai');
                updateModelStatus('loading', 'Initializing Model...');
                
                magentaModel = new music_rnn.MusicRNN('https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/melody_rnn');
                
                log('Initializing model...', 'ai');
                await magentaModel.initialize();
                
                isModelLoaded = true;
                updateModelStatus('connected', 'MelodyRNN Ready');
                log('‚úì MelodyRNN model initialized successfully!', 'ai');
                updateButtonStates();
                
            } catch (error) {
                log(`‚úó Model initialization failed: ${error.message}`, 'ai');
                updateModelStatus('disconnected', 'Model Failed');
                console.error('Model error:', error);
            }
        }

        async function testSequence() {
            if (!isModelLoaded || !magentaModel) {
                log('Model not loaded', 'ai');
                return;
            }

            try {
                log('Testing sequence generation...', 'ai');
                
                const testSeq = {
                    notes: [
                        {pitch: 60, startTime: 0, endTime: 0.5},
                        {pitch: 62, startTime: 0.5, endTime: 1.0},
                        {pitch: 64, startTime: 1.0, endTime: 1.5},
                        {pitch: 65, startTime: 1.5, endTime: 2.0}
                    ],
                    totalTime: 2.0,
                    ticksPerQuarter: 220
                };
                
                log('Test sequence created, quantizing...', 'ai');
                
                const quantizedSeq = core.sequences.quantizeNoteSequence(testSeq, 4);
                
                log('Sequence quantized successfully', 'ai');
                log(`Quantized sequence has ${quantizedSeq.notes.length} notes`, 'ai');
                
                log('Calling continueSequence...', 'ai');
                const continuation = await magentaModel.continueSequence(quantizedSeq, 8, 0.8);
                
                if (continuation && continuation.notes) {
                    log(`‚úì Generated ${continuation.notes.length} notes successfully!`, 'ai');
                    
                    if (player) {
                        player.start(continuation);
                        log('‚úì Playing generated sequence', 'ai');
                    }
                } else {
                    log('‚úó No notes generated', 'ai');
                }
                
            } catch (error) {
                log(`‚úó Sequence test failed: ${error.message}`, 'ai');
                console.error('Sequence error:', error);
            }
        }

        // Audio initialization
        function initAudioContext() {
            if (!app.audioContext) {
                app.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return app.audioContext;
        }

        // Piano sound generation with pitch bend support
        function playPianoNote(note, velocity = 127) {
            const audioContext = initAudioContext();
            const now = audioContext.currentTime;
            
            const bendRange = parseInt(document.getElementById('pitchBendRange')?.value || 2);
            const bendedNote = note + (app.currentPitchBend * bendRange);
            const fundamental = 440 * Math.pow(2, (bendedNote - 69) / 12);
            const harmonics = [1, 0.5, 0.25, 0.125, 0.0625];
            const gainNode = audioContext.createGain();
            
            const oscillators = [];
            
            harmonics.forEach((amplitude, index) => {
                const osc = audioContext.createOscillator();
                const harmGain = audioContext.createGain();
                
                osc.frequency.setValueAtTime(fundamental * (index + 1), now);
                osc.type = 'triangle';
                
                harmGain.gain.setValueAtTime(amplitude * (velocity / 127) * 0.3, now);
                harmGain.gain.exponentialRampToValueAtTime(0.001, now + 2);
                
                osc.connect(harmGain);
                harmGain.connect(gainNode);
                
                osc.start(now);
                osc.stop(now + 2);
                
                oscillators.push({ osc, gain: harmGain });
            });
            
            gainNode.connect(audioContext.destination);
            
            app.activeOscillators.set(note, {
                oscillators: oscillators,
                gainNode: gainNode,
                startTime: now,
                baseNote: note,
                velocity: velocity
            });
            
            setTimeout(() => {
                app.activeOscillators.delete(note);
            }, 2100);
        }

        // Apply pitch bend to active notes
        function applyPitchBend(bendAmount) {
            app.currentPitchBend = bendAmount;
            
            const bendRangeElement = document.getElementById('pitchBendRange');
            const bendRange = bendRangeElement ? parseInt(bendRangeElement.value) : 2;
            const currentTime = app.audioContext?.currentTime || 0;
            
            app.activeOscillators.forEach((noteData, noteKey) => {
                const bendedNote = noteData.baseNote + (bendAmount * bendRange);
                const newFundamental = 440 * Math.pow(2, (bendedNote - 69) / 12);
                
                noteData.oscillators.forEach((oscData, index) => {
                    try {
                        const harmonic = index + 1;
                        const newFreq = newFundamental * harmonic;
                        
                        if (oscData.osc.frequency && 
                            currentTime > 0 && 
                            newFreq > 20 && newFreq < 20000) {
                            oscData.osc.frequency.setValueAtTime(newFreq, currentTime);
                        }
                    } catch (error) {
                        console.debug('Oscillator update failed:', error.message);
                    }
                });
            });
            
            if (Math.abs(bendAmount) > 0.01) {
                log(`Pitch bend: ${(bendAmount * 100).toFixed(1)}% (¬±${bendRange} semitones)`, 'midi');
            }
        }

        // Ponkey sound generation - Jazz Electric Piano style
        function playPonkeySound(note, mode = 4) {
            const audioContext = initAudioContext();
            const now = audioContext.currentTime;
            const fundamental = 440 * Math.pow(2, (note - 69) / 12);
            
            // Jazz Electric Piano (Rhodes-like) sound
            const masterGain = audioContext.createGain();
            const compressor = audioContext.createDynamicsCompressor();
            
            // FM synthesis for bell-like Rhodes tone
            const carrier = audioContext.createOscillator();
            const modulator = audioContext.createOscillator();
            const modulatorGain = audioContext.createGain();
            
            // Carrier (main tone)
            carrier.type = 'sine';
            carrier.frequency.setValueAtTime(fundamental, now);
            
            // Modulator (creates the bell-like harmonics)
            modulator.type = 'sine';
            modulator.frequency.setValueAtTime(fundamental * 2, now); // 2:1 ratio for Rhodes
            modulatorGain.gain.setValueAtTime(fundamental * 0.8, now); // Modulation depth
            modulatorGain.gain.exponentialRampToValueAtTime(fundamental * 0.1, now + 1.5);
            
            // Connect FM synthesis
            modulator.connect(modulatorGain);
            modulatorGain.connect(carrier.frequency);
            
            // Add subtle chorusing for warmth (second detuned oscillator)
            const carrier2 = audioContext.createOscillator();
            carrier2.type = 'sine';
            carrier2.frequency.setValueAtTime(fundamental * 1.003, now); // Slight detune
            
            // Tremolo for jazz feel
            const tremolo = audioContext.createOscillator();
            const tremoloGain = audioContext.createGain();
            tremolo.type = 'sine';
            tremolo.frequency.setValueAtTime(5.5, now); // Tremolo rate
            tremoloGain.gain.setValueAtTime(0.08, now); // Subtle tremolo depth
            
            // Envelope - quick attack, medium sustain, smooth release
            const envGain = audioContext.createGain();
            envGain.gain.setValueAtTime(0, now);
            envGain.gain.linearRampToValueAtTime(0.35, now + 0.01); // Quick attack
            envGain.gain.exponentialRampToValueAtTime(0.2, now + 0.15); // Initial decay
            envGain.gain.exponentialRampToValueAtTime(0.001, now + 2.5); // Release
            
            // Warm lowpass filter
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(fundamental * 6, now);
            filter.frequency.exponentialRampToValueAtTime(fundamental * 2, now + 1);
            filter.Q.setValueAtTime(0.7, now);
            
            // Connect everything
            carrier.connect(envGain);
            carrier2.connect(envGain);
            envGain.connect(filter);
            
            tremolo.connect(tremoloGain);
            tremoloGain.connect(masterGain.gain);
            
            filter.connect(masterGain);
            masterGain.gain.setValueAtTime(0.5, now);
            masterGain.connect(compressor);
            compressor.connect(audioContext.destination);
            
            // Start all oscillators
            carrier.start(now);
            carrier2.start(now);
            modulator.start(now);
            tremolo.start(now);
            
            // Stop after release
            carrier.stop(now + 2.5);
            carrier2.stop(now + 2.5);
            modulator.stop(now + 2.5);
            tremolo.stop(now + 2.5);
        }

        function testPonkeySound() {
            log('Testing Jazz E-Piano sound...', 'ponkey');
            playPonkeySound(60, 4);
            log('‚úì Jazz E-Piano sound played', 'ponkey');
        }

        // Update UI indicators
        function updateIndicator(elementId, connected, text) {
            const indicator = document.getElementById(elementId);
            const status = document.getElementById(elementId.replace('Indicator', 'Status'));
            
            indicator.className = `status-indicator ${connected ? 'connected' : 'disconnected'}`;
            if (status) status.textContent = text;
        }

        // MIDI Functions
        async function requestMIDIAccess() {
            try {
                const midiAccess = await navigator.requestMIDIAccess();
                const inputs = Array.from(midiAccess.inputs.values());
                
                if (inputs.length === 0) {
                    log('No MIDI devices found - using computer keyboard', 'midi');
                    alert('No MIDI devices detected. You can use your computer keyboard instead!\n\nKeys: A S D F G H J K (white keys)\nW E T Y U (black keys)\nZ/X to change octave');
                    return;
                }

                showMIDIDeviceList(inputs);
            } catch (error) {
                log(`MIDI access failed: ${error.message}`, 'midi');
                alert('MIDI access denied. You can still use your computer keyboard!');
            }
        }

        function showMIDIDeviceList(devices) {
            const modal = document.getElementById('midiModal');
            const deviceList = document.getElementById('midiDeviceList');
            
            deviceList.innerHTML = '';
            devices.forEach(device => {
                const item = document.createElement('div');
                item.className = 'device-item';
                item.textContent = device.name || `Device ${device.id}`;
                item.onclick = () => connectMIDIDevice(device);
                deviceList.appendChild(item);
            });
            
            modal.classList.add('show');
        }

        function connectMIDIDevice(device) {
            app.midiInput = device;
            device.onmidimessage = handleMIDIMessage;
            
            updateIndicator('midiIndicator', true, 'Connected');
            document.getElementById('midiDeviceName').textContent = device.name || 'Unknown Device';
            document.getElementById('midiModal').classList.remove('show');
            
            log(`MIDI device connected: ${device.name}`, 'midi');
            updateButtonStates();
        }

        function handleMIDIMessage(event) {
            const [status, data1, data2] = event.data;
            const messageType = status & 0xF0;
            const channel = status & 0x0F;
            
            if (messageType === 0x90 && data2 > 0) {
                handleNoteOn(data1, data2);
            } else if (messageType === 0x80 || (messageType === 0x90 && data2 === 0)) {
                handleNoteOff(data1);
            } else if (messageType === 0xE0) {
                const pitchBendValue = (data2 << 7) | data1;
                const bendAmount = (pitchBendValue - 8192) / 8192;
                handlePitchBend(bendAmount);
            } else if (messageType === 0xB0) {
                handleControlChange(data1, data2);
            }
        }

        let lastPonkeyBendSend = 0;
        const PONKEY_BEND_THROTTLE = 50;

        function handlePitchBend(bendAmount) {
            applyPitchBend(bendAmount);
            
            const now = Date.now();
            if (app.ponkeyCharacteristic && (now - lastPonkeyBendSend > PONKEY_BEND_THROTTLE)) {
                try {
                    const bendValue = Math.round((bendAmount + 1) * 63.5);
                    const lsb = bendValue & 0x7F;
                    const msb = (bendValue >> 7) & 0x7F;
                    sendPonkeyMIDI(0xE0, lsb, msb);
                    lastPonkeyBendSend = now;
                } catch (error) {
                    console.debug('Ponkey pitch bend send failed:', error.message);
                }
            }
        }

        function handleControlChange(control, value) {
            log(`MIDI CC: ${control} = ${value}`, 'midi');
            
            switch(control) {
                case 1:
                    handleModulation(value / 127);
                    break;
                case 7:
                    handleVolume(value / 127);
                    break;
                case 64:
                    handleSustain(value >= 64);
                    break;
                case 120:
                    handleAllSoundOff();
                    break;
                case 123:
                    handleAllNotesOff();
                    break;
                default:
                    if (app.ponkeyCharacteristic) {
                        try {
                            sendPonkeyMIDI(0xB0, control, value);
                        } catch (error) {
                            console.debug('Ponkey CC send failed:', error.message);
                        }
                    }
            }
        }

        function handleModulation(amount) {
            if (amount > 0.1) {
                log(`Modulation: ${(amount * 100).toFixed(1)}%`, 'midi');
            }
        }

        function handleVolume(amount) {
            log(`Volume: ${(amount * 100).toFixed(1)}%`, 'midi');
        }

        function handleSustain(isOn) {
            log(`Sustain pedal: ${isOn ? 'ON' : 'OFF'}`, 'midi');
        }

        function handleAllSoundOff() {
            log('All Sound Off received', 'midi');
            app.activeOscillators.forEach((noteData, noteKey) => {
                noteData.oscillators.forEach(oscData => {
                    try {
                        oscData.osc.stop();
                    } catch (error) {}
                });
            });
            app.activeOscillators.clear();
        }

        function handleAllNotesOff() {
            log('All Notes Off received', 'midi');
            app.activeOscillators.forEach((noteData, noteKey) => {
                noteData.oscillators.forEach(oscData => {
                    try {
                        const currentTime = app.audioContext.currentTime;
                        oscData.gain.gain.exponentialRampToValueAtTime(0.001, currentTime + 0.1);
                    } catch (error) {}
                });
            });
            
            setTimeout(() => {
                app.activeOscillators.clear();
            }, 150);
        }

        function handleNoteOn(note, velocity) {
            app.noteCount++;
            document.getElementById('activityCounter').textContent = app.noteCount;
            
            if (app.activeOscillators.has(note)) {
                const existingNote = app.activeOscillators.get(note);
                existingNote.oscillators.forEach(oscData => {
                    try {
                        oscData.osc.stop();
                    } catch (error) {}
                });
                app.activeOscillators.delete(note);
            }
            
            playPianoNote(note, velocity);
            
            const sequenceNote = {
                pitch: note,
                startTime: app.inputSequence.length * 0.5,
                endTime: (app.inputSequence.length + 1) * 0.5,
                velocity: velocity
            };
            
            app.inputSequence.push(sequenceNote);
            
            if (app.inputSequence.length > 8) {
                app.inputSequence.shift();
                app.inputSequence.forEach((note, i) => {
                    note.startTime = i * 0.5;
                    note.endTime = (i + 1) * 0.5;
                });
            }
            
            visualizeNote(note, 'active');
            
            log(`Note On: ${note} (vel: ${velocity}) [seq: ${app.inputSequence.length}]`, 'midi');
            
            if (app.aiActive && isModelLoaded && app.inputSequence.length >= 2) {
                scheduleAIResponse();
            }
        }

        function handleNoteOff(note) {
            app.activeOscillators.delete(note);
        }

        // AI Response
        function scheduleAIResponse() {
            const delay = parseInt(document.getElementById('responseDelay').value);
            
            setTimeout(() => {
                generateMagentaResponse();
            }, delay);
        }

        async function generateMagentaResponse() {
            if (!isModelLoaded || !magentaModel || app.inputSequence.length === 0) {
                log('Cannot generate response: Model not loaded or no input', 'ai');
                return;
            }

            try {
                log('Generating AI response...', 'ai');
                
                const temperature = parseFloat(document.getElementById('temperature').value);
                const steps = parseInt(document.getElementById('responseSteps').value);
                const swingAmount = parseInt(document.getElementById('swingAmount').value) / 100;
                
                // Create seed sequence
                const seedSequence = {
                    notes: app.inputSequence.slice(),
                    totalTime: app.inputSequence.length * 0.5,
                    ticksPerQuarter: 220
                };
                
                const quantizedSeed = core.sequences.quantizeNoteSequence(seedSequence, 4);
                
                let continuation;
                
                if (currentModelType === 'improv_rnn') {
                    // ImprovRNN needs chord progression
                    const progressionKey = document.getElementById('chordProgression').value;
                    const progression = CHORD_PROGRESSIONS[progressionKey];
                    
                    // Build chord string for the steps
                    const chordSequence = [];
                    let totalSteps = 0;
                    while (totalSteps < steps) {
                        for (const item of progression) {
                            if (totalSteps >= steps) break;
                            const stepsToAdd = Math.min(item.steps, steps - totalSteps);
                            for (let i = 0; i < stepsToAdd; i++) {
                                chordSequence.push(item.chord);
                            }
                            totalSteps += stepsToAdd;
                        }
                    }
                    
                    log(`Using chords: ${[...new Set(chordSequence.slice(0, 8))].join(' ‚Üí ')}...`, 'ai');
                    
                    continuation = await magentaModel.continueSequence(
                        quantizedSeed, 
                        steps, 
                        temperature,
                        chordSequence
                    );
                } else {
                    // MelodyRNN and AttentionRNN
                    continuation = await magentaModel.continueSequence(quantizedSeed, steps, temperature);
                }
                
                if (continuation && continuation.notes && continuation.notes.length > 0) {
                    log(`Generated ${continuation.notes.length} notes!`, 'ai');
                    
                    // Apply swing
                    if (swingAmount > 0) {
                        continuation.notes = applySwing(continuation.notes, swingAmount);
                    }
                    
                    // Add velocity variation for more human feel
                    continuation.notes = addVelocityVariation(continuation.notes);
                    
                    playMagentaResponse(continuation.notes);
                } else {
                    log('No response generated', 'ai');
                }
                
            } catch (error) {
                log(`Generation error: ${error.message}`, 'ai');
                console.error('AI error:', error);
            }
        }

        // Apply swing timing to notes
        function applySwing(notes, amount) {
            return notes.map((note, i) => {
                const newNote = { ...note };
                // Swing affects off-beat notes (odd 8th notes)
                const beatPosition = (note.quantizedStartStep || 0) % 2;
                if (beatPosition === 1) {
                    // Delay off-beat notes
                    const swingDelay = amount * 0.33; // Max 33% of beat
                    if (newNote.startTime !== undefined) {
                        newNote.startTime += swingDelay * 0.25;
                    }
                }
                return newNote;
            });
        }

        // Add velocity variation for jazz feel
        function addVelocityVariation(notes) {
            return notes.map((note, i) => {
                const newNote = { ...note };
                // Random variation ¬±20
                const variation = (Math.random() - 0.5) * 40;
                // Accent on beats 2 and 4 (jazz feel)
                const beatPosition = (note.quantizedStartStep || i) % 4;
                const accent = (beatPosition === 1 || beatPosition === 3) ? 15 : 0;
                
                newNote.velocity = Math.max(40, Math.min(127, 
                    (note.velocity || 80) + variation + accent
                ));
                return newNote;
            });
        }

        function playMagentaResponse(notes) {
            notes.forEach((note, index) => {
                const delay = (note.startTime || index * 0.2) * 1000;
                
                setTimeout(() => {
                    playPonkeySound(note.pitch);
                    visualizeNote(note.pitch, 'ai-response');
                    sendToPonkey(note.pitch, note.velocity || 80, true);
                    
                    setTimeout(() => {
                        sendToPonkey(note.pitch, 0, true);
                    }, 300);
                    
                    log(`AI: ${note.pitch} (vel: ${Math.round(note.velocity || 80)})`, 'ai');
                }, delay);
            });
        }

        // Ponkey Functions
        async function connectPonkey() {
            try {
                document.getElementById('ponkeyModal').classList.add('show');
                log('Requesting Ponkey device...', 'ponkey');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ 
                        services: [PONKEY_SERVICE_UUID],
                        name: 'Ponkey'
                    }],
                    optionalServices: [PONKEY_SERVICE_UUID]
                });
                
                log(`Ponkey device found: ${device.name}`, 'ponkey');
                
                const server = await device.gatt.connect();
                log('Connected to GATT server', 'ponkey');
                
                const service = await server.getPrimaryService(PONKEY_SERVICE_UUID);
                log('Got primary service', 'ponkey');
                
                app.ponkeyCharacteristic = await service.getCharacteristic(PONKEY_CHAR_UUID);
                log('Got characteristic', 'ponkey');
                
                await app.ponkeyCharacteristic.startNotifications();
                app.ponkeyCharacteristic.addEventListener('characteristicvaluechanged', handlePonkeyData);
                
                app.ponkeyDevice = device;
                updateIndicator('ponkeyIndicator', true, 'Connected');
                document.getElementById('ponkeyDeviceName').textContent = device.name;
                document.getElementById('ponkeyModal').classList.remove('show');
                
                log('Ponkey connected successfully!', 'ponkey');
                updateButtonStates();
                
            } catch (error) {
                log(`Ponkey connection failed: ${error.message}`, 'ponkey');
                document.getElementById('ponkeyModal').classList.remove('show');
                
                if (error.name === 'NotFoundError') {
                    alert('Ponkey„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\n- Ponkey„ÅÆÈõªÊ∫ê„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n- ‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n- Ëøë„Åè„Å´„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                } else if (error.name === 'SecurityError') {
                    alert('BluetoothÊé•Á∂ö„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\nHTTPS„Çµ„Ç§„Éà„Åæ„Åü„ÅØlocalhost„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert(`Êé•Á∂ö„Ç®„É©„Éº: ${error.message}`);
                }
            }
        }

        async function sendToPonkey(note, velocity, isAI) {
            log(`sendToPonkey called: note=${note}, vel=${velocity}, isAI=${isAI}, connected=${!!app.ponkeyCharacteristic}`, 'ponkey');
            
            if (!app.ponkeyCharacteristic) {
                log('Ponkey not connected - skipping send', 'ponkey');
                return;
            }
            
            const ponkeyKey = note % 16;
            
            try {
                if (velocity > 0) {
                    await sendPonkeyMIDI(0x90, ponkeyKey, velocity);
                } else {
                    await sendPonkeyMIDI(0x80, ponkeyKey, 0);
                }
                
                log(`‚Üí Ponkey Key ${ponkeyKey} ${velocity > 0 ? 'ON' : 'OFF'} (sent!)`, 'ponkey');
            } catch (error) {
                log(`Ponkey send error: ${error.message}`, 'ponkey');
            }
        }

        async function sendPonkeyMIDI(status, data1, data2) {
            if (!app.ponkeyCharacteristic) return;
            
            const packet = new Uint8Array([0x80, 0x80, status, data1, data2]);
            await app.ponkeyCharacteristic.writeValue(packet);
        }

        function handlePonkeyData(event) {
            const value = event.target.value;
            log(`Ponkey data received: ${Array.from(new Uint8Array(value)).map(b => b.toString(16)).join(' ')}`, 'ponkey');
        }

        // Visualization
        function initPianoRoll() {
            const pianoRoll = document.getElementById('pianoRoll');
            pianoRoll.innerHTML = '';
            
            for (let i = 0; i < 16; i++) {
                const noteBar = document.createElement('div');
                noteBar.className = 'note-bar';
                noteBar.dataset.note = i;
                pianoRoll.appendChild(noteBar);
            }
        }

        function visualizeNote(midiNote, className) {
            const noteIndex = midiNote % 16;
            const noteBar = document.querySelector(`#pianoRoll [data-note="${noteIndex}"]`);
            
            if (noteBar) {
                noteBar.classList.add(className);
                setTimeout(() => {
                    noteBar.classList.remove(className);
                }, 1000);
            }
        }

        // UI Control
        function updateButtonStates() {
            const keyboardReady = app.keyboardEnabled;
            const midiConnected = !!app.midiInput;
            const modelLoaded = isModelLoaded;
            const canStart = (keyboardReady || midiConnected) && modelLoaded;
            
            document.getElementById('startDuetBtn').disabled = !canStart || app.aiActive;
            document.getElementById('stopDuetBtn').disabled = !app.aiActive;
        }

        function startAIDuet() {
            app.aiActive = true;
            updateButtonStates();
            log('AI Duet started - play some notes!', 'ai');
        }

        function stopAIDuet() {
            app.aiActive = false;
            updateButtonStates();
            log('AI Duet stopped', 'ai');
        }

        function resetAll() {
            app.inputSequence = [];
            app.noteCount = 0;
            document.getElementById('activityCounter').textContent = '0';
            document.getElementById('logPanel').innerHTML = '';
            log('System reset', 'info');
        }

        // Progress bar update
        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressStatus').textContent = status;
        }

        // Auto initialization
        async function autoInitialize() {
            const selectedModel = document.getElementById('aiModel')?.value || 'improv_rnn';
            currentModelType = selectedModel;
            
            try {
                // Step 1: Check libraries
                updateProgress(10, 'Checking Tone.js...');
                await delay(300);
                
                if (typeof Tone === 'undefined') {
                    throw new Error('Tone.js not loaded');
                }
                updateProgress(20, '‚úì Tone.js loaded');
                await delay(200);
                
                updateProgress(30, 'Checking TensorFlow.js...');
                await delay(300);
                
                if (typeof tf === 'undefined') {
                    throw new Error('TensorFlow.js not loaded');
                }
                updateProgress(40, '‚úì TensorFlow.js loaded');
                await delay(200);
                
                updateProgress(50, 'Checking Magenta.js...');
                await delay(300);
                
                if (typeof core === 'undefined' || typeof music_rnn === 'undefined') {
                    throw new Error('Magenta.js not loaded');
                }
                player = new core.Player();
                updateProgress(60, '‚úì Magenta.js loaded');
                await delay(200);
                
                // Step 2: Load selected model
                const modelName = {
                    'melody_rnn': 'MelodyRNN',
                    'attention_rnn': 'AttentionRNN', 
                    'improv_rnn': 'ImprovRNN (Jazz)'
                }[selectedModel];
                
                updateProgress(70, `Loading ${modelName}...`);
                updateModelStatus('loading', `Loading ${modelName}...`);
                
                const modelUrl = MODEL_URLS[selectedModel];
                magentaModel = new music_rnn.MusicRNN(modelUrl);
                await magentaModel.initialize();
                
                isModelLoaded = true;
                updateProgress(100, `‚úì ${modelName} ready!`);
                updateModelStatus('connected', `${modelName} Ready`);
                
                log(`‚úì ${modelName} initialized!`, 'ai');
                
                // Hide loading section
                await delay(500);
                document.getElementById('loadingSection').style.display = 'none';
                updateButtonStates();
                updateChordProgressionVisibility();
                
            } catch (error) {
                updateProgress(0, `‚ùå Error: ${error.message}`);
                updateModelStatus('disconnected', 'Initialization Failed');
                log(`Initialization error: ${error.message}`, 'ai');
            }
        }

        // Reload model when changed
        async function reloadModel() {
            const selectedModel = document.getElementById('aiModel').value;
            
            if (selectedModel === currentModelType && isModelLoaded) {
                log('Same model already loaded', 'ai');
                document.getElementById('modelReloadSection').style.display = 'none';
                return;
            }
            
            // Dispose old model
            if (magentaModel) {
                try {
                    magentaModel.dispose();
                } catch (e) {
                    console.log('Model dispose:', e);
                }
            }
            
            isModelLoaded = false;
            currentModelType = selectedModel;
            
            // Show loading
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('modelReloadSection').style.display = 'none';
            
            const modelName = {
                'melody_rnn': 'MelodyRNN',
                'attention_rnn': 'AttentionRNN',
                'improv_rnn': 'ImprovRNN (Jazz)'
            }[selectedModel];
            
            try {
                updateProgress(50, `Loading ${modelName}...`);
                updateModelStatus('loading', `Loading ${modelName}...`);
                
                const modelUrl = MODEL_URLS[selectedModel];
                magentaModel = new music_rnn.MusicRNN(modelUrl);
                await magentaModel.initialize();
                
                isModelLoaded = true;
                updateProgress(100, `‚úì ${modelName} ready!`);
                updateModelStatus('connected', `${modelName} Ready`);
                log(`‚úì Switched to ${modelName}`, 'ai');
                
                await delay(500);
                document.getElementById('loadingSection').style.display = 'none';
                updateButtonStates();
                
            } catch (error) {
                updateProgress(0, `‚ùå Error: ${error.message}`);
                updateModelStatus('disconnected', 'Model Load Failed');
                log(`Model load error: ${error.message}`, 'ai');
            }
        }

        function updateChordProgressionVisibility() {
            const selectedModel = document.getElementById('aiModel').value;
            const chordGroup = document.getElementById('chordProgressionGroup');
            chordGroup.style.display = (selectedModel === 'improv_rnn') ? 'flex' : 'none';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize
        function initUI() {
            initPianoRoll();
            initKeyboardInput();
            initVirtualKeyboardClicks();
            
            // Initialize audio on first click
            document.body.addEventListener('click', () => {
                initAudioContext();
                log('Audio system initialized', 'info');
            }, { once: true });
            
            // Main controls
            document.getElementById('connectMidiBtn').onclick = requestMIDIAccess;
            document.getElementById('connectPonkeyBtn').onclick = connectPonkey;
            document.getElementById('startDuetBtn').onclick = startAIDuet;
            document.getElementById('stopDuetBtn').onclick = stopAIDuet;
            document.getElementById('resetBtn').onclick = resetAll;
            
            // Modal controls
            document.getElementById('cancelMidiBtn').onclick = () => {
                document.getElementById('midiModal').classList.remove('show');
            };
            document.getElementById('refreshMidiBtn').onclick = requestMIDIAccess;
            document.getElementById('cancelPonkeyBtn').onclick = () => {
                document.getElementById('ponkeyModal').classList.remove('show');
            };
            
            // Settings
            document.getElementById('responseDelay').oninput = (e) => {
                document.getElementById('responseDelayValue').textContent = e.target.value + 'ms';
            };
            document.getElementById('temperature').oninput = (e) => {
                const val = parseFloat(e.target.value);
                let emoji = 'üé≤';
                if (val < 0.6) emoji = 'üéØ';
                else if (val > 1.2) emoji = 'üî•';
                document.getElementById('temperatureValue').textContent = val + ' ' + emoji;
            };
            document.getElementById('responseSteps').oninput = (e) => {
                document.getElementById('responseStepsValue').textContent = e.target.value + ' steps';
            };
            document.getElementById('swingAmount').oninput = (e) => {
                const val = parseInt(e.target.value);
                let emoji = 'üé∫';
                if (val < 30) emoji = 'üé∏';
                else if (val > 70) emoji = 'üé∑';
                document.getElementById('swingAmountValue').textContent = val + '% ' + emoji;
            };
            
            // Model selection
            document.getElementById('aiModel').onchange = (e) => {
                updateChordProgressionVisibility();
                document.getElementById('modelReloadSection').style.display = 'block';
            };
            document.getElementById('reloadModelBtn').onclick = reloadModel;
            
            updateButtonStates();
            log('Ponkey AI Duet initialized', 'info');
            log('Computer keyboard input enabled (A-K for notes, Z/X for octave)', 'keyboard');
            
            // Auto-initialize after short delay
            setTimeout(autoInitialize, 500);
        }

        // Start
        window.addEventListener('DOMContentLoaded', initUI);

        // Check APIs
        if (!navigator.requestMIDIAccess) {
            console.warn('Web MIDI API not supported. Using computer keyboard.');
        }
        if (!navigator.bluetooth) {
            console.warn('Web Bluetooth API not supported.');
        }
    </script>
</body>
</html>
